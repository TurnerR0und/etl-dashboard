<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK House Price Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* A little bit of custom styling for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
        }
        select:disabled {
            background-color: #f3f4f6; /* A slightly grayer background when disabled */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">UK House Price Index Dashboard</h1>
            <p class="text-gray-600 mt-2">Visualizing regional housing market trends over time.</p>
        </header>

        <main class="bg-white rounded-lg shadow-lg p-4 md:p-6">
            <!-- Controls Section -->
            <div class="flex flex-col md:flex-row items-center gap-4 mb-6">
                <label for="region-select" class="font-semibold">Select a Region:</label>
                <select id="region-select" class="w-full md:w-auto p-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                    <option value="">Loading regions...</option>
                </select>
            </div>

            <!-- Chart and Loading State Section -->
            <div id="chart-container" class="relative min-h-[50vh]">
                <!-- Loading Spinner -->
                <div id="loader" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10 hidden">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                </div>
                 <!-- Initial Message -->
                <div id="initial-message" class="absolute inset-0 flex items-center justify-center text-gray-500">
                    <p>Please select a region to view the data chart.</p>
                </div>
                <!-- Chart Canvas -->
                <canvas id="priceChart" class=""></canvas>
            </div>

             <!-- Error Message Display -->
            <div id="error-message" class="mt-4 text-center text-red-600 font-semibold hidden"></div>
        </main>
    </div>

    <script>
        // Use strict mode to catch common coding mistakes
        'use strict';

        // --- Main execution wrapped in a function ---
        (function() {
            console.log("Dashboard script initializing...");

            const regionSelect = document.getElementById('region-select');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            const initialMessage = document.getElementById('initial-message');
            const chartCanvas = document.getElementById('priceChart');
            let priceChart = null;

            // Check if all essential elements are found
            if (!regionSelect || !loader || !errorMessage || !initialMessage || !chartCanvas) {
                console.error("Initialization failed: One or more essential HTML elements are missing from the page.");
                return; // Stop execution if the page isn't set up correctly
            }

            const API_BASE_URL = '';

            async function loadRegions() {
                console.log("Attempting to load regions...");
                try {
                    const response = await fetch(`${API_BASE_URL}/regions`);
                    console.log("Fetch response received for /regions");
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log("Region data successfully parsed:", data);
                    
                    regionSelect.innerHTML = '<option value="">-- Please select a region --</option>';
                    data.regions.forEach(region => {
                        const option = document.createElement('option');
                        option.value = region;
                        option.textContent = region;
                        regionSelect.appendChild(option);
                    });
                    regionSelect.disabled = false;
                    console.log("Region dropdown populated and enabled.");
                } catch (error) {
                    console.error('Error fetching regions:', error);
                    regionSelect.innerHTML = '<option value="">Error loading regions</option>';
                    regionSelect.disabled = true;
                    showError("Error: Could not load region data from the API.");
                }
            }

            async function loadRegionData(regionName) {
                if (!regionName) {
                    if(priceChart) priceChart.destroy();
                    chartCanvas.style.display = 'none';
                    initialMessage.style.display = 'flex';
                    return;
                }

                showLoader(true);
                initialMessage.style.display = 'none';
                chartCanvas.style.display = 'block';
                showError('');

                try {
                    const response = await fetch(`${API_BASE_URL}/data/${encodeURIComponent(regionName)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    updateChart(result.data);
                } catch (error) {
                    console.error(`Error fetching data for ${regionName}:`, error);
                    showError(`Failed to load data for ${regionName}. Please try again.`);
                } finally {
                    showLoader(false);
                }
            }

            function updateChart(data) {
                const labels = data.map(d => d.date.split('T')[0]);
                const prices = data.map(d => d.average_price);
                const indices = data.map(d => d.index);
                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Average Price (£)', data: prices, borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)', yAxisID: 'y-price', tension: 0.1, fill: true,
                    }, {
                        label: 'Price Index', data: indices, borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)', yAxisID: 'y-index', tension: 0.1, fill: true,
                    }]
                };
                const config = {
                    type: 'line', data: chartData,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Date' } },
                            'y-price': { type: 'linear', position: 'left', title: { display: true, text: 'Average Price (£)' }, grid: { drawOnChartArea: false, }, },
                            'y-index': { type: 'linear', position: 'right', title: { display: true, text: 'Price Index (relative to baseline)' } }
                        },
                        plugins: { tooltip: { mode: 'index', intersect: false, }, legend: { position: 'top', } }
                    }
                };
                if (priceChart) priceChart.destroy();
                priceChart = new Chart(chartCanvas, config);
            }

            function showLoader(visible) { loader.classList.toggle('hidden', !visible); }
            function showError(message) {
                console.error("Displaying error to user:", message);
                errorMessage.textContent = message;
                errorMessage.classList.toggle('hidden', !message);
            }

            function initializeApp() {
                 console.log("DOM content loaded. Initializing app.");
                 chartCanvas.style.display = 'none';
                 regionSelect.addEventListener('change', (event) => { loadRegionData(event.target.value); });
                 loadRegions();
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
        })();
    </script>
</body>
</html>

